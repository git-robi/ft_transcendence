# ModSecurity v3 Configuration
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off
SecResponseBodyMimeType text/plain text/html text/xml
SecResponseBodyLimit 524288

# Data directory
SecDataDir /var/log/nginx/modsec/

# Logging configuration
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/nginx/modsec_audit.log

# Limit configuration
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# Timeout for processing (removed - not valid in ModSecurity v3)
# SecRequestBodyTimeoutAction Reject

# Include OWASP Core Rule Set
# Note: ModSecurity v3 does not support wildcards in Include,
# so we only include the setup and essential rules
Include /etc/nginx/crs/crs-setup.conf

# Custom rules to adjust false positives
# Especially for WebSockets and REST APIs

# Disable problematic rules for WebSockets (adjust as needed)
SecRuleRemoveById 942100
SecRuleRemoveById 942110
SecRuleRemoveById 942200
SecRuleRemoveById 942260
SecRuleRemoveById 942270
SecRuleRemoveById 942300
SecRuleRemoveById 942310
SecRuleRemoveById 942330
SecRuleRemoveById 942340
SecRuleRemoveById 942350
SecRuleRemoveById 942360
SecRuleRemoveById 942370
SecRuleRemoveById 942380
SecRuleRemoveById 942390
SecRuleRemoveById 942400
SecRuleRemoveById 942410
SecRuleRemoveById 942430
SecRuleRemoveById 942440
SecRuleRemoveById 942450
SecRuleRemoveById 942460
SecRuleRemoveById 942470
SecRuleRemoveById 942480
SecRuleRemoveById 942500

# Allow JSON in body for REST APIs
SecRule REQUEST_HEADERS:Content-Type "@beginsWith application/json" \
    "id:1000,\
    phase:1,\
    pass,\
    nolog,\
    ctl:requestBodyProcessor=JSON"

# Adjust rules for authentication endpoints
SecRule REQUEST_URI "@beginsWith /api/v1/auth" \
    "id:1001,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=942100,\
    ctl:ruleRemoveById=942110,\
    ctl:ruleRemoveById=942200"

# Configuration for WebSockets (handshake)
SecRule REQUEST_HEADERS:Upgrade "@streq websocket" \
    "id:1002,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=942100,\
    ctl:ruleRemoveById=942110,\
    ctl:ruleRemoveById=942200,\
    ctl:ruleRemoveById=942260,\
    ctl:ruleRemoveById=942270"

