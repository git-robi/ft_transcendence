# ModSecurity v3 Configuration
SecRuleEngine On
SecRequestBodyAccess On
SecResponseBodyAccess Off
SecResponseBodyMimeType text/plain text/html text/xml
SecResponseBodyLimit 524288

# Directorio de datos
SecDataDir /var/log/nginx/modsec/

# Configuración de logging
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/nginx/modsec_audit.log

# Configuración de límites
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyLimitAction Reject

# Timeout para procesamiento (removido - no es válido en ModSecurity v3)
# SecRequestBodyTimeoutAction Reject

# Incluir OWASP Core Rule Set
# Nota: ModSecurity v3 no soporta wildcards en Include, 
# así que incluimos solo el setup y las reglas esenciales
Include /etc/nginx/crs/crs-setup.conf

# Reglas personalizadas para ajustar falsos positivos
# Especialmente para WebSockets y APIs REST

# Desactivar reglas problemáticas para WebSockets (ajustar según necesidad)
SecRuleRemoveById 942100
SecRuleRemoveById 942110
SecRuleRemoveById 942200
SecRuleRemoveById 942260
SecRuleRemoveById 942270
SecRuleRemoveById 942300
SecRuleRemoveById 942310
SecRuleRemoveById 942330
SecRuleRemoveById 942340
SecRuleRemoveById 942350
SecRuleRemoveById 942360
SecRuleRemoveById 942370
SecRuleRemoveById 942380
SecRuleRemoveById 942390
SecRuleRemoveById 942400
SecRuleRemoveById 942410
SecRuleRemoveById 942430
SecRuleRemoveById 942440
SecRuleRemoveById 942450
SecRuleRemoveById 942460
SecRuleRemoveById 942470
SecRuleRemoveById 942480
SecRuleRemoveById 942500

# Permitir JSON en body para APIs REST
SecRule REQUEST_HEADERS:Content-Type "@beginsWith application/json" \
    "id:1000,\
    phase:1,\
    pass,\
    nolog,\
    ctl:requestBodyProcessor=JSON"

# Ajustar reglas para endpoints de autenticación
SecRule REQUEST_URI "@beginsWith /api/v1/auth" \
    "id:1001,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=942100,\
    ctl:ruleRemoveById=942110,\
    ctl:ruleRemoveById=942200"

# Configuración para WebSockets (handshake)
SecRule REQUEST_HEADERS:Upgrade "@streq websocket" \
    "id:1002,\
    phase:1,\
    pass,\
    nolog,\
    ctl:ruleRemoveById=942100,\
    ctl:ruleRemoveById=942110,\
    ctl:ruleRemoveById=942200,\
    ctl:ruleRemoveById=942260,\
    ctl:ruleRemoveById=942270"

